## Описание

Приложение состоит из нескольких сервисов, которые запускаются в docker контейнере.

1. db - база данных Postgres
2. rabbitmq3 - менеджер очередей
3. api - рест апи
4. loader - сервис загрузки 
5. redo - сервис обработки загруженных данных

### Dockefile
В данном случае приходится скачивать и устанавливать весь senzing. Поэтому сначала 
устанавливаются необходимые переменные окружения, потом скачиваются пакеты и затем устанавливаются.
Также для корректной работы необходимо скопировать файлы из /opt/senzing/g2/resources/templates/ в
 /etc/opt/senzing/

### API
Принимает запрос и запускает обработку и загрузку данных.
Обязательные параметры запроса: 

    - file(object): файл с данными для загрузки
    - datasource(string): название датасорса для загрузки данных
    - is_need_mapping(string): флаг, определяющий, требуется ли маппинг из ftm в senzing.
      Принимает значение 'true' или 'false'

При получении запроса сервис проверяет наличие всех параметров и :
1. Запускает создание нового датасорса. Если датасорс с таким именем уже существует, то новый создаваться не будет.
2. Если параметр is_need_mapping имеет значение true, запускается маппинг. Файл читается 
построчно(без промежуточного сохранения на диск), для каждой строки делается маппинг и обработанная 
строка отправляется в Реббит.
3. Если параметр is_need_mapping имеет значение false - файл читается построчно и 
каждая строка отправляется в Реббит

### Loader

Этот сервис занимается загрузкой данных в сензинг. При старте инициализируются 
необходимые компоненты сензинга - G2ConfigMgr, G2Config, G2Engine. Сервис подключается 
к очереди Реббита в качестве слушателя. Как только в очереди появляются сообщения, 
сервис берет сообщение из очереди, формирует добавочные поля и отправляет сформированные 
данные в сензинг. 
При остановке сервиса(или всего докер контейнера) происходит выгрузка и сохранение 
конфига со всеми датасорсами.

### Redo

Сервис запускается при старте контейнера и работает в качестве демона в фоновом режиме.
Каждые 10 секунд проихсодит проверка на наличие записей, требующих обработки. В случае 
наличия таких записей запускается processRedoRecord


### Конфигурироване

Конфиг приложения находится в libs/conf.py Ниже описаны самые важные параметры:
- VERBOSE_LOG - включает вывод логов из сензинг
- INIT_JSON - json файл с параметрами для инициализации senzing
- CONFIG_JSON - конфиг с датасорсами, связями, фичами и тому подобное
- FORCE_LOAD_CONFIG - флаг, указывающий приложению, что нужно загрузить конфиг из CONFIG_JSON даже если активный конфиг уже существует

При первом запуске приложение загрузит и создаст дефолтный конфиг из файла senzing_ftm_config.json
Во время работы приложения будут добавляться новые датасорсы, поэтому, в случае остановки 
докер контейнера, конфиг из базы данных сензинга будет выгружен и сохранен в файл senzing_ftm_config.json
Таким образом можно добавить что-то в конфиг. Например, нужно добавить новую фичу. 
1. Останавливаем докер контейнер
2. Редактируем выгруженный конфиг(senzing_ftm_config.json)
3. Устанавливаем FORCE_LOAD_CONFIG = True
4. Запускаем докер контейнер

### Запуск

sudo docker-compose  up --build
